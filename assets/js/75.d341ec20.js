(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{514:function(t,s,a){"use strict";a.r(s);var n=a(76),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"mktemp-命令-trap-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mktemp-命令-trap-命令"}},[t._v("#")]),t._v(" mktemp 命令，trap 命令")]),t._v(" "),a("p",[t._v("Bash 脚本有时需要创建临时文件或临时目录。常见的做法是，在"),a("code",[t._v("/tmp")]),t._v("目录里面创建文件或目录，这样做有很多弊端，使用"),a("code",[t._v("mktemp")]),t._v("命令是最安全的做法。")]),t._v(" "),a("h2",{attrs:{id:"临时文件的安全问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#临时文件的安全问题"}},[t._v("#")]),t._v(" 临时文件的安全问题")]),t._v(" "),a("p",[t._v("直接创建临时文件，尤其在"),a("code",[t._v("/tmp")]),t._v("目录里面，往往会导致安全问题。")]),t._v(" "),a("p",[t._v("首先，"),a("code",[t._v("/tmp")]),t._v("目录是所有人可读写的，任何用户都可以往该目录里面写文件。创建的临时文件也是所有人可读的。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" /tmp/info.txt\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" -l /tmp/info.txt\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" ruanyf ruanyf "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("月 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":12 /tmp/info.txt\n")])])]),a("p",[t._v("上面命令在"),a("code",[t._v("/tmp")]),t._v("目录直接创建文件，该文件默认是所有人可读的。")]),t._v(" "),a("p",[t._v("其次，如果攻击者知道临时文件的文件名，他可以创建符号链接，链接到临时文件，可能导致系统运行异常。攻击者也可能向脚本提供一些恶意数据。因此，临时文件最好使用不可预测、每次都不一样的文件名，防止被利用。")]),t._v(" "),a("p",[t._v("最后，临时文件使用完毕，应该删除。但是，脚本意外退出时，往往会忽略清理临时文件。")]),t._v(" "),a("p",[t._v("生成临时文件应该遵循下面的规则。")]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("创建前检查文件是否已经存在。")]),t._v(" "),a("li",[t._v("确保临时文件已成功创建。")]),t._v(" "),a("li",[t._v("临时文件必须有权限的限制。")]),t._v(" "),a("li",[t._v("临时文件要使用不可预测的文件名。")]),t._v(" "),a("li",[t._v("脚本退出时，要删除临时文件（使用"),a("code",[t._v("trap")]),t._v("命令）。")])])]),t._v(" "),a("h2",{attrs:{id:"mktemp-命令的用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mktemp-命令的用法"}},[t._v("#")]),t._v(" mktemp 命令的用法")]),t._v(" "),a("p",[a("code",[t._v("mktemp")]),t._v("命令就是为安全创建临时文件而设计的。虽然在创建临时文件之前，它不会检查临时文件是否存在，但是它支持唯一文件名和清除机制，因此可以减轻安全攻击的风险。")]),t._v(" "),a("p",[t._v("直接运行"),a("code",[t._v("mktemp")]),t._v("命令，就能生成一个临时文件。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ mktemp\n/tmp/tmp.4GcsWSG4vj\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" -l /tmp/tmp.4GcsWSG4vj\n-rw------- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" ruanyf ruanyf "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("月 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(":49 /tmp/tmp.4GcsWSG4vj\n")])])]),a("p",[t._v("上面命令中，"),a("code",[t._v("mktemp")]),t._v("命令生成的临时文件名是随机的，而且权限是只有用户本人可读写。")]),t._v(" "),a("p",[t._v("Bash 脚本使用"),a("code",[t._v("mktemp")]),t._v("命令的用法如下。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("TMPFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Our temp file is '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TMPFILE")]),t._v('"')]),t._v("\n")])])]),a("p",[t._v("为了确保临时文件创建成功，"),a("code",[t._v("mktemp")]),t._v("命令后面最好使用 OR 运算符（"),a("code",[t._v("||")]),t._v("），保证创建失败时退出脚本。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("TMPFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Our temp file is '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TMPFILE")]),t._v('"')]),t._v("\n")])])]),a("p",[t._v("为了保证脚本退出时临时文件被删除，可以使用"),a("code",[t._v("trap")]),t._v("命令指定退出时的清除操作。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rm -f \"$TMPFILE\"'")]),t._v(" EXIT\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("TMPFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Our temp file is '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TMPFILE")]),t._v('"')]),t._v("\n")])])]),a("h2",{attrs:{id:"mktemp-命令的参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mktemp-命令的参数"}},[t._v("#")]),t._v(" mktemp 命令的参数")]),t._v(" "),a("p",[a("code",[t._v("-d")]),t._v("参数可以创建一个临时目录。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ mktemp -d\n/tmp/tmp.Wcau5UjmN6\n")])])]),a("p",[a("code",[t._v("-p")]),t._v("参数可以指定临时文件所在的目录。默认是使用"),a("code",[t._v("$TMPDIR")]),t._v("环境变量指定的目录，如果这个变量没设置，那么使用"),a("code",[t._v("/tmp")]),t._v("目录。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ mktemp -p /home/ruanyf/\n/home/ruanyf/tmp.FOKEtvs2H3\n")])])]),a("p",[a("code",[t._v("-t")]),t._v("参数可以指定临时文件的文件名模板，模板的末尾必须至少包含三个连续的"),a("code",[t._v("X")]),t._v("字符，表示随机字符，建议至少使用六个"),a("code",[t._v("X")]),t._v("。默认的文件名模板是"),a("code",[t._v("tmp.")]),t._v("后接十个随机字符。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ mktemp -t mytemp.XXXXXXX\n/tmp/mytemp.yZ1HgZV\n")])])]),a("h2",{attrs:{id:"trap-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#trap-命令"}},[t._v("#")]),t._v(" trap 命令")]),t._v(" "),a("p",[a("code",[t._v("trap")]),t._v("命令用来在 Bash 脚本中响应系统信号。")]),t._v(" "),a("p",[t._v("最常见的系统信号就是 SIGINT（中断），即按 Ctrl + C 所产生的信号。"),a("code",[t._v("trap")]),t._v("命令的"),a("code",[t._v("-l")]),t._v("参数，可以列出所有的系统信号。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" -l\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGHUP\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGINT\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGQUIT\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGILL\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGTRAP\n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGABRT\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGBUS\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGFPE\t "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGKILL\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGUSR1\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGSEGV\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGUSR2\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGPIPE\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGALRM\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGTERM\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGSTKFLT\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGCHLD\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGCONT\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGSTOP\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGTSTP\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGTTIN\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGTTOU\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGURG\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGXCPU\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGXFSZ\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGVTALRM\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGPROF\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGWINCH\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGIO\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGPWR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGSYS\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("34")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("35")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+1\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+2\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("37")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+3\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("38")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+4\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("39")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+5\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+6\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("41")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+7\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+8\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("43")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+9\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("44")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+10\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("45")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+11\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("46")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+12\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("47")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+13\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+14\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("49")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMIN+15\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-14\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("51")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-13\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("52")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-12\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-11\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("54")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-10\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("55")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-9\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-8\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("57")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-7\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-6\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("59")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-5\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-4\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("61")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-3\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("62")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-2\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX-1\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SIGRTMAX\n")])])]),a("p",[a("code",[t._v("trap")]),t._v("的命令格式如下。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("动作"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("信号1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("信号2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),a("p",[t._v("上面代码中，“动作”是一个 Bash 命令，“信号”常用的有以下几个。")]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("HUP：编号1，脚本与所在的终端脱离联系。")]),t._v(" "),a("li",[t._v("INT：编号2，用户按下 Ctrl + C，意图让脚本终止运行。")]),t._v(" "),a("li",[t._v("QUIT：编号3，用户按下 Ctrl + 斜杠，意图退出脚本。")]),t._v(" "),a("li",[t._v("KILL：编号9，该信号用于杀死进程。")]),t._v(" "),a("li",[t._v("TERM：编号15，这是"),a("code",[t._v("kill")]),t._v("命令发出的默认信号。")]),t._v(" "),a("li",[t._v("EXIT：编号0，这不是系统信号，而是 Bash 脚本特有的信号，不管什么情况，只要退出脚本就会产生。")])])]),t._v(" "),a("p",[a("code",[t._v("trap")]),t._v("命令响应"),a("code",[t._v("EXIT")]),t._v("信号的写法如下。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rm -f \"$TMPFILE\"'")]),t._v(" EXIT\n")])])]),a("p",[t._v("上面命令中，脚本遇到"),a("code",[t._v("EXIT")]),t._v("信号时，就会执行"),a("code",[t._v('rm -f "$TMPFILE"')]),t._v("。")]),t._v(" "),a("p",[t._v("trap 命令的常见使用场景，就是在 Bash 脚本中指定退出时执行的清理命令。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rm -f \"$TMPFILE\"'")]),t._v(" EXIT\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("TMPFILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" /etc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TMPFILE")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -qi "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kernel"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TMPFILE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'find'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),a("p",[t._v("上面代码中，不管是脚本正常执行结束，还是用户按 Ctrl + C 终止，都会产生"),a("code",[t._v("EXIT")]),t._v("信号，从而触发删除临时文件。")]),t._v(" "),a("p",[t._v("注意，"),a("code",[t._v("trap")]),t._v("命令必须放在脚本的开头。否则，它上方的任何命令导致脚本退出，都不会被它捕获。")]),t._v(" "),a("p",[t._v("如果"),a("code",[t._v("trap")]),t._v("需要触发多条命令，可以封装一个 Bash 函数。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("egress")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  command1\n  command2\n  command3\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("trap")]),t._v(" egress EXIT\n")])])]),a("h2",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.putorius.net/working-with-temporary-files.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Working with Temporary Files and Directories in Shell Scripts"),a("OutboundLink")],1),t._v(", Steven Vona")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.putorius.net/using-trap-to-exit-bash-scripts-cleanly.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Using Trap to Exit Bash Scripts Cleanly"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://mywiki.wooledge.org/SignalTrap",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sending and Trapping Signals"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);